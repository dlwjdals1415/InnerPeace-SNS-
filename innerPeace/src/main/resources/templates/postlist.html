<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="kr">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Inner Peace</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='css/base.css'>
    <link rel='stylesheet' type='text/css' media='screen' href='css/write.css'>
    <link rel='stylesheet' type='text/css' media='screen' href='css/sidebar.css'>
    <link rel='stylesheet' type='text/css' media='screen' href='css/postlist.css'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
</head>
<body>
<input type="checkbox" class="checkbox" id="create">
<input type="checkbox" class="checkbox" id="search">
<input type="checkbox" class="checkbox" id="more">
<th:block th:if="${session.loginedHealer != null}">
    <section class="write-container" th:replace="~{fragment/write::write}"></section>
</th:block>
<th:block th:if="${session.loginedHealer != null}">
    <section class="sidebar" th:replace="~{fragment/sidebar::healer_sidebar}"></section>
</th:block>
<th:block th:unless="${session.loginedHealer != null}">
    <section class="sidebar" th:replace="~{fragment/sidebar::user_sidebar}"></section>
</th:block>
<article class="searchbar" th:replace="~{fragment/searchbar::searchbar}">
</article>
<th:block th:if="${session.loginedHealer != null}">
    <section class="map-section" th:replace="~{fragment/writeMap::map-section}"></section>
</th:block>
<th:block th:if="${session.loginedHealer != null}">
    <article class="menubar" th:replace="~{fragment/menu::healer_menu}"></article>
</th:block>
<th:block th:unless="${session.loginedHealer != null}">
    <article class="menubar" th:replace="~{fragment/menu::user_menu}"></article>
</th:block>
<section class="po_ab w100 h100 bg_f4 row z_i1">
    <header class="f_g3 bg_f4">
    </header>
    <main class="f_g5 bg_f4 col_cs main1000 overflow_y scrollbarnone" id="postList">
        <article class="followList bg_f4 w100">
            <h2>followLIst</h2>
        </article>
            <article class="post_contentList">
                <input type="hidden" id="last_post_no" th:value="${dtoList != null && !dtoList.isEmpty() ? dtoList[dtoList.size() - 1].post_no : ''}">
                <div class="post" th:each="item, status : ${dtoList}">
                    <a th:href="@{/board/post/detail/{postId}(postId=${item.post_no})}">
                        <img th:src="${item.post_image_thumbnail}" alt="Post 1" loading="lazy">
                    </a>
                </div>
            </article>
        <article class="col_cc hauto w100" id="loading">
            <div class="loadingio-spinner-reload-zv6cq6zfifd">
                <div class="ldio-dg926s5a60v">
                    <div>
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                </div>
            </div>
        </article>
    </main>
    <footer class="f_g2 bg_f4">
    </footer>
</section>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9cf7f221de3543e0bd1ed40d14a3a704&libraries=services"></script>
<script src="js/writeMap.js"></script>
<script src="js/write.js"></script>
<script th:inline="javascript">
    var scrollTimeout; // 타이머를 저장할 변수

    $('#postList').scroll(function() {
        var element = $(this);

        // 이미 설정된 타이머가 있으면 초기화
        if (scrollTimeout) {
            clearTimeout(scrollTimeout);
        }

        // 새로운 타이머 설정
        scrollTimeout = setTimeout(function() {
            if (element.scrollTop() + element.innerHeight() >= element[0].scrollHeight - 30) {
                element.scrollTop(element.prop("scrollHeight"));
                // 2초 지연 후의 로직을 여기에 추가
                setTimeout(function() {
                    var post_no = $('#last_post_no').val();

                    $.ajax({
                        url: '/board/post/list_scroll',
                        type: 'POST',
                        data: {
                            "post_no": post_no
                        },
                        success: function(response) {
                            // 성공적으로 데이터를 받아온 후 할 작업
                            // 여기에 데이터 처리 로직 추가
                            response.forEach(function(item) {
                                // 각 항목에 대해 수행할 작업
                                // 예를 들어, 받아온 데이터를 이용하여 리스트 아이템을 생성하고 페이지에 추가
                                var postDetailUrl = '/board/post/detail/' + item.post_no;
                                // 이미지 태그 생성
                                var imgTag = $('<img>', {
                                    "src": item.post_image_thumbnail,
                                    "alt": "Post " + item.post_no,
                                    "loading": "lazy",
                                });
                                // a 태그 생성 및 href 속성 설정
                                var aTag = $('<a>', {
                                    "href": postDetailUrl
                                }).append(imgTag); // 이미지 태그를 a 태그 안에 넣기

                                // div 태그 생성 및 a 태그 포함
                                var divTag = $('<div>', {
                                    "class": "post" // div에 클래스 추가
                                }).append(aTag); // a 태그를 div 태그 안에 넣기

                                // 생성된 div 태그를 페이지의 특정 요소에 추가
                                $('.post_contentList').append(divTag);
                            });

                            // 모든 데이터를 페이지에 추가한 후, post_no 값을 업데이트(다음 요청을 위해)
                            if(response.length > 0) {
                                var lastPostNo = response[response.length - 1].post_no;
                                $('#last_post_no').val(lastPostNo);
                            }
                        },
                        error: function(error) {
                            // 에러 처리
                        },
                    });
                }, 2000); // 20초 지연
            }
        }, 1000); // 스크롤 이벤트의 1초 지연
    });
</script>
</body>

</html>